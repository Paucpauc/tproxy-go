name: Nightly Build

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  nightly-build:
    name: Nightly Multi-Arch Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all binaries
        run: |
          ./docker-build-all-binary.sh
          echo "Binaries built:"
          ls -la build/

      - name: Build all packages
        run: |
          ./docker-build-packages-minimal.sh
          echo "Packages built:"
          ls -la build/packages/

      - name: Build Docker images
        run: |
          ./docker-build.sh nightly false
          echo "Docker images built"

      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-build-${{ github.sha }}
          path: |
            build/
          retention-days: 7

  nightly-test:
    name: Nightly Comprehensive Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run comprehensive tests
        run: |
          make docker-test-all

      - name: Build and test all architectures
        run: |
          for arch in amd64 arm64 arm; do
            echo "Testing $arch..."
            ./docker-build-binary.sh $arch
            # Basic binary validation
            file build/tproxy-$arch
            # Test that binary can start
            timeout 5s ./build/tproxy-$arch --help || true
          done

  security-scan:
    name: Nightly Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: 0  # Don't fail the build for vulnerabilities

      - name: Check for dependency updates
        run: |
          go list -m -u all
          echo "Consider running 'go get -u ./...' to update dependencies"